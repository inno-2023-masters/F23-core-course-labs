# Kubernetes Secrets and Hashicorp Vault
## Kubernetes Secrets
### Creating a secret `lab-secret`
````
% kubectl create secret generic lab-secret --from-literal=secret=SECRET_VALUE
secret/lab-secret created
````
### Verifying secret 
* Get secretes:
  ````
  % kubectl get secrets
    NAME                               TYPE                 DATA   AGE
    lab-secret                         Opaque               1      3m2s
  ````
* Describe secret:
  ````
  % kubectl describe secret lab-secret 
    Name:         lab-secret
    Namespace:    default
    Labels:       <none>
    Annotations:  <none>
    
    Type:  Opaque
    
    Data
    ====
    secret:  12 bytes
  ````
### Decoding secrete value:
````
% kubectl get secret lab-secret -o jsonpath='{.data.secret}' | base64 --decode
SECRET_VALUE
````

## Managing secrets with Helm 
I've followed a proposed tutorial to generate secret for this task
### Preparing secret
* I've installed helm plugin for secretes:
  ````
  % helm plugin install https://github.com/zendesk/helm-secrets
  ````
* After i've installed `gpg` and generated key
  ````
  % gpg --gen-key
  ````
  Sensitive data:
  ````
  secret: SECRET_VALUE
  ````
* Finally, i've created `./secrets.yaml` file with `sops`

### Adding secret to the helm chart 
* I've created `./app-python/templates/secrets.yaml` file with the following content:
  ````
  apiVersion: v1
  kind: Secret
  metadata:
    name: helm-secret
    labels:
      app: app-python
      chart: '{{ .Chart.Name }}-{{ .Chart.Version }}'
      release: '{{ .Release.Name }}'
      heritage: '{{ .Release.Service }}'
  type: Opaque
  data:
    secret: {{ .Values.secret | b64enc | quote }}
  ````
* I've also added new section to `./app-python/templates/deployment.yaml` file
  ````
  env:
  - name: HELM_SECRET_EXAMPLE
    valueFrom:
      secretKeyRef:
        name: helm-secret
        key: secret
  ````
* Finally, installing Helm chart
````
 % helm secrets install app-python ./app-python -f ./secrets.yaml
NAME: app-python
LAST DEPLOYED: Tue Nov 14 14:38:26 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  http://python.app/
./secrets.yaml.dec
````
### Verifying:
* Getting pods:
  ````
   % kubectl get po                                                
     NAME                          READY   STATUS    RESTARTS   AGE
     app-python-6c7b5c6bb8-9sdvg   1/1     Running   0          47s
     app-python-6c7b5c6bb8-hgvmx   1/1     Running   0          47s
     app-python-6c7b5c6bb8-p2d5k   1/1     Running   0          47s
  ````
* Checking env inside the pod:
  ````
  % kubectl exec app-python-6c7b5c6bb8-9sdvg -- printenv | grep HELM_SECRET_EXAMPLE
    HELM_SECRET_EXAMPLE=SECRET_VALUE
  ````
## Vault Secret Management System
This task is done for bonus application (`app-go`) to save the work done in previous tasks
### Preparing secret 
  * Firstly, i've installed vault helm chart 
    ````
    % kubectl get pods
      NAME                                    READY   STATUS    RESTARTS   AGE
      app-python-6c7b5c6bb8-9sdvg             1/1     Running   0          78m
      app-python-6c7b5c6bb8-hgvmx             1/1     Running   0          78m
      app-python-6c7b5c6bb8-p2d5k             1/1     Running   0          78m
      vault-0                                 1/1     Running   0          23m
      vault-agent-injector-5cd8b87c6c-ms54j   1/1     Running   0          23m
    ````
  * Enabling kv-v2 secrets:
    ````
    % kubectl exec -it vault-0 -- /bin/sh
      / $ vault secrets enable -path=internal kv-v2
      Success! Enabled the kv-v2 secrets engine at: internal/
    ````
  * Setting secret:
    ````
    / $ vault kv put internal/database/config secret="SECRET_VALUE"
    ======== Secret Path ========
    internal/data/database/config
    
    ======= Metadata =======
    Key                Value
    ---                -----
    created_time       2023-11-14T13:00:26.793280323Z
    custom_metadata    <nil>
    deletion_time      n/a
    destroyed          false
    version            1
    ````
  * Verifying:
    ````
    / $ vault kv get internal/database/config
    ======== Secret Path ========
    internal/data/database/config
    
    ======= Metadata =======
    Key                Value
    ---                -----
    created_time       2023-11-14T13:00:26.793280323Z
    custom_metadata    <nil>
    deletion_time      n/a
    destroyed          false
    version            1
    
    ===== Data =====
    Key       Value
    ---       -----
    secret    SECRET_VALUE
    ````
### Configuring authentication 
* Enabling auth 
  ````
  / $ vault auth enable kubernetes
  Success! Enabled kubernetes auth method at: kubernetes/
  ````
* Configure auth 
  ````
  / $ vault write auth/kubernetes/config \
  >       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
  Success! Data written to: auth/kubernetes/config
  ````
* Writing policy 
  ````
  / $ vault policy write internal-app - <<EOF
  > path "internal/data/database/config" {
  >    capabilities = ["read"]
  > }
  > EOF
  Success! Uploaded policy: internal-app
  ````
* Creating role
  ````
  / $ vault write auth/kubernetes/role/internal-app \
  >       bound_service_account_names=internal-app \
  >       bound_service_account_namespaces=default \
  >       policies=internal-app \
  >       ttl=24h
  Success! Data written to: auth/kubernetes/role/internal-app
  ````
### Implementing vault secret in a chart
* Creating service account:
  ````
  % kubectl create sa internal-app
  serviceaccount/internal-app created
  ````
* Verifying account:
  ````
   % kubectl get serviceaccounts
  NAME                   SECRETS   AGE
  default                0         15d
  internal-app           0         28m
  vault                  0         5h
  vault-agent-injector   0         5h
  ````

* Updating `./app-go/values.yaml` file
  ````
  serviceAccount:
  create: false
  automount: true
  annotations: {}
  name: "internal-app"


  podAnnotations:
    vault.hashicorp.com/agent-inject: "true"
    vault.hashicorp.com/role: "internal-app"
    vault.hashicorp.com/agent-inject-secret-secrets.txt: "internal/data/secrets"
  ````
* Install chart 
  ````
   % helm install app-go ./app-go    
  NAME: app-go
  LAST DEPLOYED: Tue Nov 14 16:21:24 2023
  NAMESPACE: default
  STATUS: deployed
  REVISION: 1
  NOTES:
  1. Get the application URL by running these commands:
    http://go.app/
  ````
* Getting pods:
  ````
   % kubectl get pods                                     
  NAME                                    READY   STATUS    RESTARTS   AGE
  app-go-8b9d989b8-t2xxf                  2/2     Running   0          64s
  app-go-8b9d989b8-vzrzn                  2/2     Running   0          64s
  app-go-8b9d989b8-w8822                  2/2     Running   0          64s
  vault-0                                 1/1     Running   0          81m
  vault-agent-injector-5cd8b87c6c-ms54j   1/1     Running   0          81m
  ````
* Connecting to container:
  ````
  $ kubectl exec -it app-go-8b9d989b8-t2xxf -- bash
  ````
* Getting secrets:
  ````
  / $ cat /vault/secrets/secrets.txt
  data: map[secret:SECRET_VALUE]
  metadata: map[created_time:2023-11-14T13:00:26.793280323Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
  ````
* Get filesystem info 
  ````
  / $ df -h
  Filesystem                      Size  Used Avail Use% Mounted on
  overlay                          69G   16G   50G  25% /
  tmpfs                            64M     0   64M   0% /dev
  tmpfs                           5.9G     0  5.9G   0% /sys/fs/cgroup
  tmpfs                           628M  4.0K  628M   1% /vault/secrets
  /dev/disk/by-label/data-volume   69G   16G   50G  25% /etc/hosts
  shm                              64M     0   64M   0% /dev/shm
  tmpfs                           628M   12K  628M   1% /run/secrets/kubernetes.io/serviceaccount
  tmpfs                           5.9G     0  5.9G   0% /proc/acpi
  tmpfs                           5.9G     0  5.9G   0% /proc/scsi
  tmpfs                           5.9G     0  5.9G   0% /sys/firmware
  ````
* Changing secret template in pod annotation in `values.yaml`:
  ````
  vault.hashicorp.com/agent-inject-secret-secrets.txt: |
    {{- with secret "internal/data/secrets" -}}
    {{ .Data.data.secret }}
    {{- end -}}
  ````
* Getting secret one more time 
  ````
  / $ cat /vault/secrets/secrets.txt
  SECRET_VALUE
  ````
## Bonus task:
### Resource management:
* app-python
  ````
  resources:
   limits:
     cpu: 100m
     memory: 128Mi
   requests:
     cpu: 100m
     memory: 128Mi
  ````
* app-go 
  ````
  resources:
   limits:
     cpu: 100m
     memory: 128Mi
   requests:
     cpu: 100m
     memory: 128Mi
  ````
### Adding envs for containers
* Adding env to `templates/_heplers.tpl` files:
  * Python
    ````
      {{/*
      Environment variables
      */}}
      {{- define "app-python.env" -}}
      - name: PYTHON_ENV
        value: "python_value"
      {{- end }}
    ````
  * Go 
    ````
    {{/*
    Environment variables
    */}}
    {{- define "app-go.env" -}}
    - name: GO_ENV
      value: "go_value"
    {{- end }}
    ````
      
* Adding template data to `spec.template.spec.containers.env` section in `deployment.yaml`
  * Python:
    ```
    {{- include "app-python.env" . | nindent 12 }}
    ```
  * Go:
    ```
    {{ include "app-go.env" . | nindent 12 }}
    ```
* Getting pods:
  ````
   % kubectl get pods                                     
  NAME                                    READY   STATUS    RESTARTS         AGE
  app-go-9cc5bc5d6-9w6vt                  1/1     Running      0             25s
  app-go-9cc5bc5d6-blt8s                  1/1     Running      0             25s
  app-go-9cc5bc5d6-mrt8b                  1/1     Running      0             25s
  app-python-779c59dcf8-hk9nb             1/1     Running      0             4m13s
  app-python-779c59dcf8-mkfth             1/1     Running      0             4m13s
  app-python-779c59dcf8-tz7bx             1/1     Running      0             4m13s
  vault-0                                 1/1     Running      0             5h42m
  vault-agent-injector-5cd8b87c6c-ms54j   1/1     Running      0             5h42m
  ````
* Verifying envs:
  * Python:
  ````
  % kubectl exec app-python-779c59dcf8-hk9nb -- printenv | grep PYTHON_ENV
  PYTHON_ENV=python_value
  ````
  * Go:
  ````
  % kubectl exec app-go-9cc5bc5d6-9w6vt -- printenv | grep GO_ENV
  GO_ENV=go_value
  ````


  



  

  


    

    

  