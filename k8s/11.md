# Secrets
### Creating secrets using kubectl
Using `--from-literal` flag to create secret with key-value pair.
```
vladislav5ik@AsusTuf:~$ kubectl create secret generic lab11-secret --from-literal=whoami=iamacat
secret/lab11-secret created
```

### Verifying and decoding secret
Getting secret.
```
vladislav5ik@AsusTuf:~$ kubectl get secret lab11-secret
NAME           TYPE     DATA   AGE
lab11-secret   Opaque   1      42s
```
Creating jsonpath to get data from secret and decoding it.
```
vladislav5ik@AsusTuf:~$ kubectl get secret lab11-secret -o jsonpath='{.data.*}' | base64 -d
iamacat
```

### Creating Helm config for secret
Creating `secrets.yaml` file with secret data. To simplify the process of creating secret, I used `-o yaml` flag to get yaml file with secret data.
```yaml
vladislav5ik@AsusTuf:~$ kubectl get secret app-python-secret -o yaml
apiVersion: v1
data:
  whoami: aWFtYWNhdA==
kind: Secret
metadata:
  creationTimestamp: "2023-11-13T17:58:03Z"
  name: app-python-secret
  namespace: default
  resourceVersion: "35086"
  uid: f9064a87-2faa-4c5f-9bc5-e8ed7dd2dac4
type: Opaque
```
The final `secrets.yaml` file:
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: app-python-secret
type: Opaque
data:
  whoami: aWFtYWNhdA==
```
Creating template in `_helpers.tpl` file.
```yaml
{{/*
Secrets
*/}}
{{- define "app-python-chart.secrets" -}}
{{- range $secret := .Values.secrets }}
- name: {{ $secret.name | quote }}
  valueFrom:
    secretKeyRef:
      name: "app-python-secret"
      key: {{ $secret.key | quote }}
{{- end }}
{{- end }}
```
Including template in `deployment.yaml` file.
```yaml
          env:
            {{- include "app-python-chart.secrets" . | nindent 12 }}
```
Specifying secret data in `values.yaml` file.
```yaml
secrets:
  - name: WHOAMI_SECRET
    key: whoami
```
### Applying secret to the chart
Checking if apps are running.
```
vladislav5ik@AsusTuf:~/code-iu/core-course-labs/k8s$ kubectl get po
NAME                                                      READY   STATUS    RESTARTS       AGE
golang-with-del-hooks-app-golang-chart-589cfd57c7-tmcwn   1/1     Running   3 (3h2m ago)   5d23h
python-with-del-hooks-app-python-chart-8478784cf-fbx9p    1/1     Running   0              23s
```
Applying secret using `secrets.yaml` file for Python app.
```
vladislav5ik@AsusTuf:~/code-iu/core-course-labs/k8s$ helm upgrade --install python-with-del-hooks app-python-chart/
Release "python-with-del-hooks" has been upgraded. Happy Helming!
NAME: python-with-del-hooks
LAST DEPLOYED: Tue Nov 14 00:48:35 2023
NAMESPACE: default
STATUS: deployed
REVISION: 2
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services python-with-del-hooks-app-python-chart)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
```
Applying secret using `secrets.yaml` file for Golang app.
```
vladislav5ik@AsusTuf:~/code-iu/core-course-labs/k8s$ helm upgrade --install golang-with-del-hooks app-golang-chart/
Release "golang-with-del-hooks" does not exist. Installing it now.
NAME: golang-with-del-hooks
LAST DEPLOYED: Tue Nov 14 01:15:21 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services golang-with-del-hooks-app-golang-chart)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
```
### Checking if secret is applied
Checking if secret is applied.
```
vladislav5ik@AsusTuf:~/code-iu/core-course-labs/k8s$ kubectl get secret
NAME                                          TYPE                 DATA   AGE
app-golang-secret                             Opaque               1      42s
app-python-secret                             Opaque               1      30m
sh.helm.release.v1.golang-with-del-hooks.v1   helm.sh/release.v1   1      65s
sh.helm.release.v1.python-with-del-hooks.v1   helm.sh/release.v1   1      30m
sh.helm.release.v1.python-with-del-hooks.v2   helm.sh/release.v1   1      27m
```
Output of `kubectl get po` command.
```
vladislav5ik@AsusTuf:~/code-iu/core-course-labs/k8s$ kubectl get po
NAME                                                      READY   STATUS    RESTARTS   AGE
golang-with-del-hooks-app-golang-chart-6df4c655b8-kgcxh   1/1     Running   0          18m
python-with-del-hooks-app-python-chart-8478784cf-fbx9p    1/1     Running   0          45m
```
Output of `kubectl exec` command. As we can see, secret is applied.
```
vladislav5ik@AsusTuf:~/code-iu/core-course-labs/k8s$ kubectl exec python-with-del-hooks-app-python-chart-8478784cf-fbx9p -- env | grep _SECRET
WHOAMI_SECRET=iamacat
```
Golang app doesn't have `env` command, because it's not included in the scratch docker image, so this command will fail.
```
vladislav5ik@AsusTuf:~/code-iu/core-course-labs/k8s$ kubectl exec golang-with-del-hooks-app-golang-chart-6df4c655b8-kgcxh -- env
OCI runtime exec failed: exec failed: unable to start container process: exec: "env": executable file not found in $PATH: unknown
command terminated with exit code 126
```
To list all secrets applied in both charts, I used `kubectl set env` command.
```
vladislav5ik@AsusTuf:~/code-iu/core-course-labs/k8s$ kubectl set env pods --all --list
# Pod golang-with-del-hooks-app-golang-chart-6df4c655b8-kgcxh, container app-golang-chart
# WHOAMI_SECRET from secret app-golang-secret, key whoami
# Pod python-with-del-hooks-app-python-chart-8478784cf-fbx9p, container app-python-chart
# WHOAMI_SECRET from secret app-python-secret, key whoami
```
