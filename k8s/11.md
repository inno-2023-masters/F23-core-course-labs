## Task 1: Kubernetes Secrets and Resource Management (6 points):
```
$ kubectl create secret generic db-user-pass --from-literal=username=admin --from-literal=password='mypassword'
secret/db-user-pass created

$ kubectl get secrets
NAME           TYPE     DATA   AGE
db-user-pass   Opaque   2      6s

$ kubectl get secret db-user-pass -o jsonpath='{.data}'
{"password":"bXlTdHJvbmdQYXNzd29yZA==","username":"YWRtaW4="}

$ kubectl get secret db-user-pass -o jsonpath='{.data.password}' | base64 --decode
myStrongPassword

$ kubectl get secret db-user-pass -o jsonpath='{.data.username}' | base64 --decode
admin

$ helm install my-python-web ./my-helm-app --values ./my-helm-app/values.python.yaml
NAME: my-python-web
LAST DEPLOYED: Wed Nov 15 01:18:34 2023
NAMESPACE: default
STATUS: deployed
...

$ kubectl get pods,svc
NAME                              READY   STATUS    RESTARTS   AGE
pod/python-app-6df5dcf44d-s7jhr   1/1     Running   0          35s

NAME                         TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
service/kubernetes           ClusterIP      10.96.0.1        <none>        443/TCP          38m
service/python-web-app-svc   LoadBalancer   10.104.125.151   <pending>     5000:32027/TCP   35s

$ kubectl exec python-app-6df5dcf44d-s7jhr -- printenv | grep PASSWORD
PASSWORD=mypassword

$ kubectl exec python-app-6df5dcf44d-s7jhr -- printenv | grep USERNAME
USERNAME=admin

$ helm uninstall my-python-web
release "my-python-web" uninstalled
```

## Task 2: Vault Secret Management System

The vault installation is a bit different due to having problems with downloading vault from https://helm.releases.hashicorp.com
```
$ git clone git@github.com:hashicorp/vault-helm.git

$ helm install vault ./vault-helm --values ./vault-helm/values.yaml --set "server.dev.enabled=true"
NAME: vault
LAST DEPLOYED: Wed Nov 15 01:38:04 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
...
```
### Set a secret in Vault:
```
$ kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-14T22:40:09.521201906Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-14T22:40:09.521201906Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
/ $ exit

```

### Configure Kubernetes authentication:
```
$ kubectl exec -it vault-0 -- /bin/sh
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ echo $KUBERNETES_PORT_443_TCP_ADDR
10.96.0.1
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=internal-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
/ $ exit

```

### Define a Kubernetes service account:
```
$ kubectl create sa internal-app
serviceaccount/internal-app created

$ kubectl get serviceaccounts
NAME                   SECRETS   AGE
default                0         65m
internal-app           0         5s
vault                  0         8m15s
vault-agent-injector   0         8m15s

```


### Injecting secrets into the pod:
```
$ kubectl patch deployment python-app --patch "$(cat my-helm-app/patch-inject-secrets.yaml)"
deployment.apps/python-app patched

$ kubectl get pods,svc
NAME                                        READY   STATUS    RESTARTS   AGE
pod/python-app-cf5595786-d8bf7              2/2     Running   0          22s
pod/vault-0                                 1/1     Running   0          75m
pod/vault-agent-injector-5497b47d74-qptbp   1/1     Running   0          75m

NAME                               TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
service/kubernetes                 ClusterIP      10.96.0.1        <none>        443/TCP             133m
service/python-web-app-svc         LoadBalancer   10.106.186.162   <pending>     5000:30083/TCP      57m
service/vault                      ClusterIP      10.99.197.88     <none>        8200/TCP,8201/TCP   75m
service/vault-agent-injector-svc   ClusterIP      10.107.80.35     <none>        443/TCP             75m
service/vault-internal             ClusterIP      None             <none>        8200/TCP,8201/TCP   75m
```

### Ensure credentials are injected (4 points):
```
$ kubectl exec -it python-app-cf5595786-d8bf7 -- bash
Defaulted container "python-web" out of: python-web, vault-agent, vault-agent-init (init)

appuser@python-app-cf5595786-d8bf7:/app$ df -h
Filesystem                          Size  Used Avail Use% Mounted on
overlay                             450G   74G  353G  18% /
tmpfs                                64M     0   64M   0% /dev
tmpfs                                16G  4.0K   16G   1% /vault/secrets
/dev/mapper/vgbobievnodir--nu-root  450G   74G  353G  18% /etc/hosts
shm                                  64M     0   64M   0% /dev/shm
tmpfs                                16G   12K   16G   1% /run/secrets/kubernetes.io/serviceaccount
udev                                7.7G     0  7.7G   0% /dev/tty
tmpfs                               7.7G     0  7.7G   0% /proc/acpi
tmpfs                               7.7G     0  7.7G   0% /proc/scsi
tmpfs                               7.7G     0  7.7G   0% /sys/firmware

appuser@python-app-cf5595786-d8bf7:/app$ cat /vault/secrets/database-config.txt
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2023-11-14T22:40:09.521201906Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```

```
$ helm uninstall my-python-web
release "my-python-web" uninstalled
```

## Bonus (2.5 points):

```
$ helm install my-python-web ./my-helm-app --values ./my-helm-app/values.python.yaml
NAME: my-python-web
LAST DEPLOYED: Wed Nov 15 03:57:20 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
...

$ helm install my-go-web ./my-helm-app --values ./my-helm-app/values.go.yaml
NAME: my-go-web
LAST DEPLOYED: Wed Nov 15 03:51:18 2023
NAMESPACE: default
STATUS: deployed
...

$ kubectl get pods,svc
NAME                                        READY   STATUS    RESTARTS   AGE
pod/go-app-8645697858-skvbp                 1/1     Running   0          6m38s
pod/python-app-58567cb7c9-scsx6             1/1     Running   0          37s
pod/vault-0                                 1/1     Running   0          140m
pod/vault-agent-injector-5497b47d74-qptbp   1/1     Running   0          140m

NAME                               TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
service/go-web-app-svc             LoadBalancer   10.110.92.151    <pending>     8080:31729/TCP      6m38s
service/kubernetes                 ClusterIP      10.96.0.1        <none>        443/TCP             3h17m
service/python-web-app-svc         LoadBalancer   10.110.200.117   <pending>     5000:30002/TCP      37s
service/vault                      ClusterIP      10.99.197.88     <none>        8200/TCP,8201/TCP   140m
service/vault-agent-injector-svc   ClusterIP      10.107.80.35     <none>        443/TCP             140m
service/vault-internal             ClusterIP      None             <none>        8200/TCP,8201/TCP   140m
```

### Python-web describe:
```
$ kubectl describe pod python-app-58567cb7c9-scsx6
Name:             python-app-58567cb7c9-scsx6
Namespace:        default
Priority:         0
Service Account:  internal-app
Node:             minikube/192.168.49.2
Start Time:       Wed, 15 Nov 2023 03:57:28 +0300
Labels:           app=python
                  pod-template-hash=58567cb7c9
Annotations:      <none>
Status:           Running
IP:               10.244.0.23
IPs:
  IP:           10.244.0.23
Controlled By:  ReplicaSet/python-app-58567cb7c9
Containers:
  python-web:
    Container ID:   containerd://4a9d201ec36793ef962033ddf880c7018488103c920a5cb1d3a67c47da6e7417
    Image:          bobievnodir/app_python:latest
    Image ID:       docker.io/bobievnodir/app_python@sha256:52fb98be225f132daf424e773e2839028cc6de9d6fd3ddaf53b8e687d3cc196e
    Port:           5000/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Wed, 15 Nov 2023 03:57:30 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     500m
      memory:  128Mi
    Requests:
      cpu:     250m
      memory:  64Mi
    Environment:
      PASSWORD:  <set to the key 'password' in secret 'db-user-pass'>  Optional: false
      USERNAME:  <set to the key 'username' in secret 'db-user-pass'>  Optional: false
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-grmfm (ro)
Conditions:
  Type              Status
  Initialized       True 
  Ready             True 
  ContainersReady   True 
  PodScheduled      True 
Volumes:
  kube-api-access-grmfm:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   Burstable
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  2m17s  default-scheduler  Successfully assigned default/python-app-58567cb7c9-scsx6 to minikube
  Normal  Pulling    2m17s  kubelet            Pulling image "bobievnodir/app_python:latest"
  Normal  Pulled     2m15s  kubelet            Successfully pulled image "bobievnodir/app_python:latest" in 1.513475474s (1.513562405s including waiting)
  Normal  Created    2m15s  kubelet            Created container python-web
  Normal  Started    2m15s  kubelet            Started container python-web
```

### Go-web describe:
```
$ kubectl describe pod go-app-8645697858-skvbp
Name:             go-app-8645697858-skvbp
Namespace:        default
Priority:         0
Service Account:  internal-app
Node:             minikube/192.168.49.2
Start Time:       Wed, 15 Nov 2023 03:51:27 +0300
Labels:           app=go
                  pod-template-hash=8645697858
Annotations:      <none>
Status:           Running
IP:               10.244.0.20
IPs:
  IP:           10.244.0.20
Controlled By:  ReplicaSet/go-app-8645697858
Containers:
  python-web:
    Container ID:   containerd://69725662df7dc7cb0547d4f0c2d7a481fb9bd3564e3b8907e788f1caaf5b46a5
    Image:          bobievnodir/app_go:latest
    Image ID:       docker.io/bobievnodir/app_go@sha256:099528b777559042a45581829cef1f1ded1b63202cee533c59aa27f0de977186
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Wed, 15 Nov 2023 03:51:33 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     500m
      memory:  128Mi
    Requests:
      cpu:     250m
      memory:  64Mi
    Environment:
      PASSWORD:  <set to the key 'password' in secret 'db-user-pass'>  Optional: false
      USERNAME:  <set to the key 'username' in secret 'db-user-pass'>  Optional: false
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-5q6rq (ro)
Conditions:
  Type              Status
  Initialized       True 
  Ready             True 
  ContainersReady   True 
  PodScheduled      True 
Volumes:
  kube-api-access-5q6rq:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   Burstable
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  2m3s  default-scheduler  Successfully assigned default/go-app-8645697858-skvbp to minikube
  Normal  Pulling    2m3s  kubelet            Pulling image "bobievnodir/app_go:latest"
  Normal  Pulled     117s  kubelet            Successfully pulled image "bobievnodir/app_go:latest" in 5.854394213s (5.854466221s including waiting)
  Normal  Created    117s  kubelet            Created container python-web
  Normal  Started    117s  kubelet            Started container python-web
```