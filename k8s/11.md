# Kubernetes Secrets and Hashicorp Vault

## Task 1

### Kubernetes Secrets and Resource Management

Creating secret:

`kubectl create secret generic db-secrets --from-literal=username=User --from-literal=password=Password`

```
secret/db-secrets created
```

Verifying secrets creation:

`kubectl get secrets`
	
```
NAME                               TYPE                 DATA   AGE
db-secrets                         Opaque               2      9s
sh.helm.release.v1.helm-hooks.v1   helm.sh/release.v1   1      4d12h
sh.helm.release.v1.python.v1       helm.sh/release.v1   1      4d12h
```
	
Secret information:

`kubectl describe secret db-secrets`

```
Name:         db-secrets
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
password:  8 bytes
username:  4 bytes
```

Decoding:

`kubectl get secret db-secrets -o jsonpath='{.data}'`

```'{"password":"UGFzc3dvcmQ=","username":"VXNlcg=="}'```

`echo 'VXNlcg==' | base64 -d`

```User```

### Helm

`kubectl get po`

```
NAME                                      READY   STATUS    RESTARTS   AGE
python-helm-app-python-54sggf5s64-mlxcq   1/1     Running   0          6m52s
```

`kubectl exec python-helm-app-python-54sggf5s64-mlxcq -- printenv | grep PASSWORD`

```PASSWORD=Password```

## Task 2

### Vault Secret Management System

`helm install vault hashicorp/vault --set "server.dev.enabled=true"`

```
NAME: vault
LAST DEPLOYED: Sun Dec 10 12:24:43 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs

Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault
```

`kubectl get pods`

```
NAME                                          READY   STATUS              RESTARTS   AGE
python-helm-app-python-54sggf5s64-mlxcq       1/1     Running             0          18m
vault-0                                       1/1     Running             0          44s
vault-agent-injector-58d4b87dñ4-bfqtq         1/1     Running             0          47s
```

### Set Secret Vault

```
kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-12-10T12:34:42.3256475Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-12-10T12:34:42.3256475Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
/ $ exit
```

### Authentication

```
kubectl exec -it vault-0 -- /bin/sh
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=internal-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
/ $ exit
```

### Validation

`kubectl get sa -n default`

```
NAME                         SECRETS   AGE
default                      0         6d
helm-hooks-helm-app-python   0         5d17h
python-helm-python           0         3d
vault                        0         4m15s
vault-agent-injector         0         4m15s
```

`kubectl get pods`

```
NAME                                          READY   STATUS    RESTARTS   AGE
python-helm-app-python-54sggf5s64-mlxcq       1/1     Running   0          18m
vault-0                                       1/1     Running   0          4m58s
vault-agent-injector-58d4b87dñ4-bfqtq         1/1     Running   0          4m59s
```

```
kubectl exec python-helm-app-python-54sggf5s64-mlxcq -it /bin/sh
$ cat /vault/secrets/database-config.txt
  data: map[password:db-secret-password username:db-readonly-username]
  metadata: map[created_time:2023-12-10T13:03:43.153670273Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```