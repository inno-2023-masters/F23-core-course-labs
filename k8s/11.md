## 1. Create a Secret Using kubectl

```bash
❯ kubectl create secret generic db-user-pass \
    --from-literal=username=admin \
    --from-literal=password='S!B\*d$zDsb='
secret/db-user-pass created
❯ kubectl get secrets
NAME                                 TYPE                 DATA   AGE
db-user-pass                         Opaque               2      2m45s
sh.helm.release.v1.app-elixir.v1     helm.sh/release.v1   1      6d23h
sh.helm.release.v1.app-python-1.v1   helm.sh/release.v1   1      6d23h
sh.helm.release.v1.app-python.v1     helm.sh/release.v1   1      6d23h
sh.helm.release.v1.helm-hooks.v1     helm.sh/release.v1   1      6d23h
❯ kubectl describe secret db-user-pass

Name:         db-user-pass
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
password:  12 bytes
username:  5 bytes
❯ kubectl get secret db-user-pass -o jsonpath='{.data}'

{"password":"UyFCXCpkJHpEc2I9","username":"YWRtaW4="}%
❯ echo 'UyFCXCpkJHpEc2I9' | base64 --decode

S!B\*d$zDsb=%
❯ echo 'YWRtaW4=' | base64 --decode

admin%
```


## 2. 

```bash
❯ helm plugin install https://github.com/jkroepke/helm-secrets

WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /Users/nikitosing/.kube/config
WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /Users/nikitosing/.kube/config
Installed plugin: secrets

❯ GPG_TTY=$(tty)
❯ export GPG_TTY

❯ helm secrets install  app ./ -f ./secrets.yaml
WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /Users/nikitosing/.kube/config
WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /Users/nikitosing/.kube/config
[helm-secrets] Decrypt: ./secrets.yaml
WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /Users/nikitosing/.kube/config
WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /Users/nikitosing/.kube/config
Release "app" has been upgraded. Happy Helming!
NAME: app
LAST DEPLOYED: Tue Nov 14 23:41:17 2023
NAMESPACE: default
STATUS: deployed
REVISION: 8
NOTES:
1. Get the application URL by running these commands:
     NOTE: It may take a few minutes for the LoadBalancer IP to be available.
           You can watch the status of by running 'kubectl get --namespace default svc -w app-app-python'
  export SERVICE_IP=$(kubectl get svc --namespace default app-app-python --template "{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}")
  echo http://$SERVICE_IP:80

[helm-secrets] Removed: ./secrets.yaml.dec

❯ kubectl get po
NAME                             READY   STATUS             RESTARTS           AGE
app-app-python-69f7c98f8-dqq49   1/1     Running            0                  76s
app-python-1-59cb6b664c-xjh96    1/1     Running            0                  7d

❯ kubectl exec app-app-python-69f7c98f8-dqq49 -- printenv | grep PASSWORD
PASSWORD=secret1234
```

## 3.

```bash
❯ kubectl exec -it vault-0 -- /bin/sh

/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-14T20:53:32.870830618Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-14T20:53:32.870830618Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=internal-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
```


```bash
❯ helm secrets upgrade  app ./ -f ./secrets.yaml
WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /Users/nikitosing/.kube/config
WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /Users/nikitosing/.kube/config
[helm-secrets] Decrypt: ./secrets.yaml
WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /Users/nikitosing/.kube/config
WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /Users/nikitosing/.kube/config
Release "app" has been upgraded. Happy Helming!
NAME: app
LAST DEPLOYED: Wed Nov 15 00:20:37 2023
NAMESPACE: default
STATUS: deployed
REVISION: 14
NOTES:
1. Get the application URL by running these commands:
     NOTE: It may take a few minutes for the LoadBalancer IP to be available.
           You can watch the status of by running 'kubectl get --namespace default svc -w app-app-python'
  export SERVICE_IP=$(kubectl get svc --namespace default app-app-python --template "{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}")
  echo http://$SERVICE_IP:80

[helm-secrets] Removed: ./secrets.yaml.dec
❯ kubectl get pods
NAME                                    READY   STATUS             RESTARTS          AGE
app-app-python-5b9bfdd74-xvrqp          2/2     Running            0                 15s
app-app-python-c5cb886c8-4w8vt          1/1     Terminating        0                 15m
app-python-1-59cb6b664c-xjh96           1/1     Running            0                 7d1h
vault-0                                 1/1     Running            0                 32m
vault-agent-injector-5cd8b87c6c-h84mt   1/1     Running            0                 32m
```

```bash
❯ kubectl get pod

❯ kubectl exec -it app-app-python-5b9bfdd74-xvrqp -- bash
Defaulted container "app-python" out of: app-python, vault-agent, vault-agent-init (init)
defaultuser@app-app-python-5b9bfdd74-xvrqp:/$ cat vault/secrets/database-config.txt
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2023-11-14T20:53:32.870830618Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
defaultuser@app-app-python-5b9bfdd74-xvrqp:/$ df -h
Filesystem      Size  Used Avail Use% Mounted on
overlay          17G  2.6G   14G  17% /
tmpfs            64M     0   64M   0% /dev
tmpfs           2.9G     0  2.9G   0% /sys/fs/cgroup
tmpfs           5.7G  4.0K  5.7G   1% /vault/secrets
/dev/vdb1        17G  2.6G   14G  17% /etc/hosts
shm              64M     0   64M   0% /dev/shm
tmpfs           5.7G   12K  5.7G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs           2.9G     0  2.9G   0% /proc/asound
tmpfs           2.9G     0  2.9G   0% /proc/acpi
tmpfs           2.9G     0  2.9G   0% /sys/firmware
```

## Bonus

```bash
❯ kubectl describe deployment  app-app-python
Name:                   app-app-python
Namespace:              default
CreationTimestamp:      Tue, 14 Nov 2023 23:41:17 +0300
Labels:                 app.kubernetes.io/instance=app
                        app.kubernetes.io/managed-by=Helm
                        app.kubernetes.io/name=app-python
                        app.kubernetes.io/version=1.16.0
                        helm.sh/chart=app-python-0.1.0
Annotations:            deployment.kubernetes.io/revision: 5
                        meta.helm.sh/release-name: app
                        meta.helm.sh/release-namespace: default
Selector:               app.kubernetes.io/instance=app,app.kubernetes.io/name=app-python
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:           app.kubernetes.io/instance=app
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/name=app-python
                    app.kubernetes.io/version=1.16.0
                    helm.sh/chart=app-python-0.1.0
  Annotations:      vault.hashicorp.com/agent-inject: true
                    vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
                    vault.hashicorp.com/role: internal-app
  Service Account:  internal-app
  Containers:
   app-python:
    Image:      nikitosing/app_python:arm_64
    Port:       80/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:      100m
      memory:   128Mi
    Liveness:   http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment:
      PASSWORD:  <set to the key 'secret' in secret 'credentials'>  Optional: false
    Mounts:      <none>
  Volumes:       <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  app-app-python-69f7c98f8 (0/0 replicas created), app-app-python-54b8c796c8 (0/0 replicas created), app-app-python-c5cb886c8 (0/0 replicas created), app-app-python-5b9bfdd74 (0/0 replicas created)
NewReplicaSet:   app-app-python-dcdb68d86 (1/1 replicas created)
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  57m    deployment-controller  Scaled up replica set app-app-python-69f7c98f8 to 1
  Normal  ScalingReplicaSet  35m    deployment-controller  Scaled up replica set app-app-python-54b8c796c8 to 1
  Normal  ScalingReplicaSet  35m    deployment-controller  Scaled down replica set app-app-python-69f7c98f8 to 0 from 1
  Normal  ScalingReplicaSet  33m    deployment-controller  Scaled up replica set app-app-python-c5cb886c8 to 1
  Normal  ScalingReplicaSet  33m    deployment-controller  Scaled down replica set app-app-python-54b8c796c8 to 0 from 1
  Normal  ScalingReplicaSet  18m    deployment-controller  Scaled up replica set app-app-python-5b9bfdd74 to 1
  Normal  ScalingReplicaSet  18m    deployment-controller  Scaled down replica set app-app-python-c5cb886c8 to 0 from 1
  Normal  ScalingReplicaSet  3m30s  deployment-controller  Scaled up replica set app-app-python-dcdb68d86 to 1
  Normal  ScalingReplicaSet  3m27s  deployment-controller  Scaled down replica set app-app-python-5b9bfdd74 to 0 from 1
```


```bash
❯ helm secrets upgrade  app ./ -f ./secrets.yaml
WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /Users/nikitosing/.kube/config
WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /Users/nikitosing/.kube/config
[helm-secrets] Decrypt: ./secrets.yaml
WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /Users/nikitosing/.kube/config
WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /Users/nikitosing/.kube/config
Release "app" has been upgraded. Happy Helming!
NAME: app
LAST DEPLOYED: Wed Nov 15 00:54:04 2023
NAMESPACE: default
STATUS: deployed
REVISION: 16
NOTES:
1. Get the application URL by running these commands:
     NOTE: It may take a few minutes for the LoadBalancer IP to be available.
           You can watch the status of by running 'kubectl get --namespace default svc -w app-app-python'
  export SERVICE_IP=$(kubectl get svc --namespace default app-app-python --template "{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}")
  echo http://$SERVICE_IP:80

[helm-secrets] Removed: ./secrets.yaml.dec
❯ kubectl get pods
NAME                                    READY   STATUS             RESTARTS          AGE
app-app-python-785fd498c-4v427          2/2     Running            0                 5s
app-app-python-dcdb68d86-792ss          2/2     Terminating        0                 18m
app-python-1-59cb6b664c-xjh96           1/1     Running            0                 7d2h
vault-0                                 1/1     Running            0                 65m
vault-agent-injector-5cd8b87c6c-h84mt   1/1     Running            0                 65m


❯ kubectl exec app-app-python-785fd498c-4v427 -- printenv | grep NEW_ENV
Defaulted container "app-python" out of: app-python, vault-agent, vault-agent-init (init)
NEW_ENV=qwerty
```
