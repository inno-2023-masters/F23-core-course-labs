# Kubernetes StatefulSet


## Task 1

```
NAME: python
LAST DEPLOYED: Mon Dec 11 23:26:24 2023
NAMESPACE: default
STATUS: pending-install
REVISION: 1
USER-SUPPLIED VALUES:
{}

COMPUTED VALUES:
affinity: {}
autoscaling:
  enabled: false
  maxReplicas: 100
  minReplicas: 1
  targetCPUUtilizationPercentage: 80
fullnameOverride: ""
image:
  pullPolicy: IfNotPresent
  repository: vladimirzelenokor/devops-python-app
  tag: latest
imagePullSecrets: []
ingress:
  annotations: {}
  className: ""
  enabled: false
  hosts:
  - host: chart-example.local
    paths:
    - path: /
      pathType: ImplementationSpecific
  tls: []
mylibchart:
  global: {}
nameOverride: ""
nodeSelector: {}
podAnnotations:
  vault.hashicorp.com/agent-inject: "true"
  vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
  vault.hashicorp.com/role: internal-app
podLabels: {}
podSecurityContext: {}
replicaCount: 1
resources:
  limits:
    cpu: 100m
    memory: 128Mi
  requests:
    cpu: 100m
    memory: 128Mi
securityContext: {}
service:
  port: 5000
  type: ClusterIP
serviceAccount:
  annotations: {}
  automount: true
  create: true
  name: ""
tolerations: []
volumeClaimTemplates:
- metadata:
    name: stateful-volume
  spec:
    accessModes:
    - ReadWriteOnce
    resources:
      requests:
        storage: 50Mi
volumeMounts:
- mountPath: /config.json
  name: config
  readOnly: true
  subPath: config.json
volumes:
- configMap:
    name: configmap
  name: config

HOOKS:
---
# Source: helm-app-python/templates/post-install-hook.yaml
apiVersion: v1
kind: Pod
metadata:
   name: postinstall-hook
   annotations:
       "helm.sh/hook": "post-install"
       "helm.sh/hook-delete-policy": hook-succeeded
spec:
  containers:
  - name: post-install-container
    image: busybox
    imagePullPolicy: IfNotPresent
    command: ['sh', '-c', 'echo The post-install hook is running && sleep 20' ]
  restartPolicy: Never
  terminationGracePeriodSeconds: 0
---
# Source: helm-app-python/templates/pre-install-hook.yaml
apiVersion: v1
kind: Pod
metadata:
  name: preinstall-hook
  annotations:
    "helm.sh/hook": "pre-install"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  containers:
  - name: pre-install-container
    image: busybox
    imagePullPolicy: IfNotPresent
    command: ['sh', '-c', 'echo The pre-install hook is running && sleep 20' ]
  restartPolicy: Never
  terminationGracePeriodSeconds: 0
---
# Source: helm-app-python/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "python-helm-app-python-test-connection"
  labels:
    helm.sh/chart: helm-python-0.1.0
    app.kubernetes.io/name: helm-app-python
    app.kubernetes.io/instance: python
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['helm-app-python:5000']
  restartPolicy: Never
MANIFEST:
---
# Source: helm-app-python/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: helm-app-python
  labels:
    helm.sh/chart: helm-python-0.1.0
    app.kubernetes.io/name: helm-app-python
    app.kubernetes.io/instance: python
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
automountServiceAccountToken: true
---
# Source: helm-app-python/templates/secrets.yaml
apiVersion: v1
data:
  password: UGFzc3dvcmQ=
  username: VXNlcg==
kind: Secret
type: Opaque
metadata:
  name: db-secrets
---
# Source: helm-app-python/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: configmap
data:
  config.json: |-
    {
      "key": "value"
    }
---
# Source: helm-app-python/templates/env-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: env-configmap
data:
  KEY: "VALUE"
---
# Source: helm-app-python/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: helm-app-python
  labels:
    helm.sh/chart: helm-python-0.1.0
    app.kubernetes.io/name: helm-app-python
    app.kubernetes.io/instance: python
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 5000
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: helm-app-python
    app.kubernetes.io/instance: python
---
# Source: helm-app-python/templates/statefulset.yaml
  selector:
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: helm-app-python
  labels:
    helm.sh/chart: helm-python-0.1.0
    app.kubernetes.io/name: helm-app-python
    app.kubernetes.io/instance: python
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  podManagementPolicy:
  selector:
    matchLabels:
      app.kubernetes.io/name: helm-app-python
      app.kubernetes.io/instance: python
  template:
    metadata:
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
        vault.hashicorp.com/role: internal-app
      labels:
        helm.sh/chart: helm-python-0.1.0
        app.kubernetes.io/name: helm-app-python
        app.kubernetes.io/instance: python
        app.kubernetes.io/version: "1.16.0"
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: python-helm-app-python
      securityContext:
        {}
      containers:
        - name: helm-app-python
          securityContext:
            {}
          image: "vladimirzelenokor/devops-python-app:latest"
          imagePullPolicy: IfNotPresent
          env:
            - name: PASSWORD
              valueFrom:
                secretKeyRef:
                  name: secret-base
                  key: password
            - name: CONFIGMAP
              valueFrom:
                configMapKeyRef:
                  name: env-configmap
                  key: KEY
          ports:
            - name: http
              containerPort: 5000
              protocol: TCP
          resources:
            limits:
              cpu: 100m
              memory: 128Mi
            requests:
              cpu: 100m
              memory: 128Mi
          volumeMounts:
            - mountPath: /config.json
              name: config
              readOnly: true
              subPath: config.json
      volumes:
        - configMap:
            name: configmap
          name: config
  volumeClaimTemplates:
  - metadata:
      name: stateful-volume
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 50Mi

NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=helm-app-python,app.kubernetes.io/instance=python" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

## Task 2

### Installation

`helm upgrade python .`

```
Release "python" has been upgraded. Happy Helming!
NAME: python
LAST DEPLOYED: Mon Dec 11 23:56:35 2023
NAMESPACE: default
STATUS: deployed
REVISION: 2
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=helm-app-python,app.kubernetes.io/instance=python" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

### Pods

`kubectl get po,sts,svc,pvc`

```
NAME                                             READY   STATUS     RESTARTS        AGE
pod/python-helm-app-python-0                     1/1     Running    0               17s
pod/python-helm-app-python-1                     1/1     Running    0               18s
pod/python-helm-app-python-2                     1/1     Running    0               18s
pod/vault-0                                  1/1     Running    2 (4h30m ago)   7d
pod/vault-agent-injector-58d4b87dñ4-q47qzd   1/1     Running    3 (4h30m ago)   7d

NAME                                      READY   AGE
statefulset.apps/python-helm-app-python   0/1     16s
statefulset.apps/vault                    1/1     9d

NAME                               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)             AGE
service/kubernetes                 ClusterIP   10.96.0.1       <none>        443/TCP             16d
service/python-helm-python         ClusterIP   10.107.68.107   <none>        5000/TCP            9d
service/vault                      ClusterIP   10.108.73.206   <none>        8200/TCP,8201/TCP   9d
service/vault-agent-injector-svc   ClusterIP   10.109.166.16   <none>        443/TCP             9d
service/vault-internal             ClusterIP   None            <none>        8200/TCP,8201/TCP   9d

NAME                                                                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/stateful-volume-python-helm-python-0   Bound    pvc-e4ac0317-5bd5-4802-8948-d6db05a9d70a   50Mi       RWO            standard       32s
```

### Replicas

`kubectl exec pod/python-helm-app-python-0 -- cat app_python/volume/visits`

```
{"count": 2}
```

`kubectl exec pod/python-helm-app-python-1 -- cat app_python/volume/visits`

```
{"count": 1}
```

`kubectl exec pod/python-helm-app-python-2 -- cat app_python/volume/visits`

```
{"count": 4}
```

### Describe and explain differences

Because the app has many persistent volumes, each node will have a separate count value.

### Ordering Guarantee and Parallel Operations

The policy for managing parallel pods was implemented. 
Because StatefulSets already give unique identifying and reliable network IDs to each pod, 
the presence of ordering guarantees is not necessary for application. 
These properties enable StatefulSet pods to retain their identity 
and affiliation with certain persistent volumes even when rescheduled to different nodes.