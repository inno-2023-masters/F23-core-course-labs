# Lab 14

## Kube Prometheus Stack description

Components included in kube-prometheus-stack:
+ Prometheus Operator
+ Highly available Prometheus
+ Highly available Alertmanager
+ Prometheus node-exporter
+ Prometheus Adapter for Kubernetes Metrics APIs
+ kube-state-metrics
+ Grafana

Roles and functions of components:

1. **Prometheus Operator:**
   - **Role:** Acts as an abstraction over Prometheus configuration and management on Kubernetes. Simplifies the deployment and management of Prometheus instances, making it easier to define and configure monitoring settings for the cluster.

2. **Highly Available Prometheus:**
   - **Role:** Core monitoring component responsible for collecting and storing time-series data. Monitors the health and performance of Kubernetes components and applications by scraping metrics from configured targets.

3. **Highly Available Alertmanager:**
   - **Role:** Manages alerts generated by Prometheus and takes actions based on defined alerting rules. Sends notifications or performs other configured actions in response to alerts, facilitating timely response to potential issues in the cluster.

4. **Prometheus node-exporter:**
   - **Role:** Collects hardware and OS-level metrics from nodes in the Kubernetes cluster.

5. **Prometheus Adapter for Kubernetes Metrics APIs:**
   - **Role:** Allows Prometheus to use metrics from Kubernetes API server as a source for scraping. Enables Prometheus to gather additional metrics about Kubernetes objects, such as pods, nodes, and services, enriching the monitoring data with Kubernetes-specific information.

6. **kube-state-metrics:**
   - **Role:** Collects and exposes Kubernetes resource state metrics.

7. **Grafana:**
   - **Role:** Provides a powerful and customizable dashboard for visualizing Prometheus metrics.

## Install Helm Charts:
```sh
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
helm install monitoring prometheus-community/kube-prometheus-stack
```

```sh
$ kubectl get po,sts,svc,pvc,cm
NAME                                                         READY   STATUS    RESTARTS      AGE
pod/alertmanager-monitoring-kube-prometheus-alertmanager-0   2/2     Running   0             34m
pod/app-go-chart-0                                           2/2     Running   0             9s
pod/app-go-chart-1                                           2/2     Running   0             9s
pod/app-python-chart-0                                       2/2     Running   0             49m
pod/monitoring-grafana-6f8d546676-75qhk                      3/3     Running   0             34m
pod/monitoring-kube-prometheus-operator-5fbb66b4b-jxfpv      1/1     Running   0             34m
pod/monitoring-kube-state-metrics-74f4d8858f-n5hw4           1/1     Running   0             34m
pod/monitoring-prometheus-node-exporter-xxlt9                1/1     Running   0             34m
pod/prometheus-monitoring-kube-prometheus-prometheus-0       2/2     Running   0             34m
pod/vault-0                                                  1/1     Running   3 (15h ago)   21d
pod/vault-agent-injector-5cd8b87c6c-fhxvs                    1/1     Running   3 (15h ago)   21d

NAME                                                                    READY   AGE
statefulset.apps/alertmanager-monitoring-kube-prometheus-alertmanager   1/1     34m
statefulset.apps/app-go-chart                                           2/2     9s
statefulset.apps/app-python-chart                                       1/1     67m
statefulset.apps/prometheus-monitoring-kube-prometheus-prometheus       1/1     34m
statefulset.apps/vault                                                  1/1     21d

NAME                                              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
service/alertmanager-operated                     ClusterIP   None            <none>        9093/TCP,9094/TCP,9094/UDP   34m
service/app-go-chart                              NodePort    10.103.95.13    <none>        80:32524/TCP                 9s
service/app-python-chart                          NodePort    10.98.130.41    <none>        80:30796/TCP                 67m
service/kubernetes                                ClusterIP   10.96.0.1       <none>        443/TCP                      35d
service/monitoring-grafana                        ClusterIP   10.106.125.33   <none>        80/TCP                       34m
service/monitoring-kube-prometheus-alertmanager   ClusterIP   10.97.0.235     <none>        9093/TCP,8080/TCP            34m
service/monitoring-kube-prometheus-operator       ClusterIP   10.109.105.72   <none>        443/TCP                      34m
service/monitoring-kube-prometheus-prometheus     ClusterIP   10.101.48.66    <none>        9090/TCP,8080/TCP            34m
service/monitoring-kube-state-metrics             ClusterIP   10.102.82.103   <none>        8080/TCP                     34m
service/monitoring-prometheus-node-exporter       ClusterIP   10.100.165.91   <none>        9100/TCP                     34m
service/prometheus-operated                       ClusterIP   None            <none>        9090/TCP                     34m
service/vault                                     ClusterIP   10.107.161.46   <none>        8200/TCP,8201/TCP            21d
service/vault-agent-injector-svc                  ClusterIP   10.109.31.149   <none>        443/TCP                      21d
service/vault-internal                            ClusterIP   None            <none>        8200/TCP,8201/TCP            21d

NAME                                                  STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/appdata-go-app-go-chart-0       Bound    pvc-67e77e5b-4991-4c6d-9dcc-bf49166e3725   15Mi       RWO            standard       7d8h
persistentvolumeclaim/appdata-go-app-go-chart-1       Bound    pvc-e3f76113-807b-4ae5-8fd6-78c1fb61521b   15Mi       RWO            standard       7d8h
persistentvolumeclaim/appdata-py-app-python-chart-0   Bound    pvc-d1b41986-e827-415e-b20b-90a19bb8cb4c   15Mi       RWO            standard       7d9h
persistentvolumeclaim/appdata-py-app-python-chart-1   Bound    pvc-41f4c94b-7e79-4dcd-9c40-4334e987c2ab   15Mi       RWO            standard       7d9h

NAME                                                                     DATA   AGE
configmap/config-map-go                                                  2      9s
configmap/config-map-py                                                  2      67m
configmap/kube-root-ca.crt                                               1      35d
configmap/monitoring-grafana                                             1      34m
configmap/monitoring-grafana-config-dashboards                           1      34m
configmap/monitoring-kube-prometheus-alertmanager-overview               1      34m
configmap/monitoring-kube-prometheus-apiserver                           1      34m
configmap/monitoring-kube-prometheus-cluster-total                       1      34m
configmap/monitoring-kube-prometheus-controller-manager                  1      34m
configmap/monitoring-kube-prometheus-etcd                                1      34m
configmap/monitoring-kube-prometheus-grafana-datasource                  1      34m
configmap/monitoring-kube-prometheus-grafana-overview                    1      34m
configmap/monitoring-kube-prometheus-k8s-coredns                         1      34m
configmap/monitoring-kube-prometheus-k8s-resources-cluster               1      34m
configmap/monitoring-kube-prometheus-k8s-resources-multicluster          1      34m
configmap/monitoring-kube-prometheus-k8s-resources-namespace             1      34m
configmap/monitoring-kube-prometheus-k8s-resources-node                  1      34m
configmap/monitoring-kube-prometheus-k8s-resources-pod                   1      34m
configmap/monitoring-kube-prometheus-k8s-resources-workload              1      34m
configmap/monitoring-kube-prometheus-k8s-resources-workloads-namespace   1      34m
configmap/monitoring-kube-prometheus-kubelet                             1      34m
configmap/monitoring-kube-prometheus-namespace-by-pod                    1      34m
configmap/monitoring-kube-prometheus-namespace-by-workload               1      34m
configmap/monitoring-kube-prometheus-node-cluster-rsrc-use               1      34m
configmap/monitoring-kube-prometheus-node-rsrc-use                       1      34m
configmap/monitoring-kube-prometheus-nodes                               1      34m
configmap/monitoring-kube-prometheus-nodes-darwin                        1      34m
configmap/monitoring-kube-prometheus-persistentvolumesusage              1      34m
configmap/monitoring-kube-prometheus-pod-total                           1      34m
configmap/monitoring-kube-prometheus-prometheus                          1      34m
configmap/monitoring-kube-prometheus-proxy                               1      34m
configmap/monitoring-kube-prometheus-scheduler                           1      34m
configmap/monitoring-kube-prometheus-workload-total                      1      34m
configmap/prometheus-monitoring-kube-prometheus-prometheus-rulefiles-0   34     34m
```

Pods:
1. **`pod/alertmanager-monitoring-kube-prometheus-alertmanager-0:`**
   - **Role:** instance of Alertmanager, which is a component used for managing and handling alerts generated by Prometheus. It coordinates the handling of alerts, including silencing, inhibition, and sending notifications.

2. **`pod/app-go-chart-0:`**
   - **Role:** Go app pod

3. **`pod/app-go-chart-1:`**
   - **Role:** Another instance of Go app

4. **`pod/app-python-chart-0:`**
   - **Role:** Python app Pod

5. **`pod/monitoring-grafana-6f8d546676-75qhk:`**
   - **Role:** This pod hosts an instance of Grafana, used for visualizing and analyzing metrics and logs from various data sources, including Prometheus.

6. **`pod/monitoring-kube-prometheus-operator-5fbb66b4b-jxfpv:`**
   - **Role:** This pod represents an instance of the Prometheus Operator, a tool used for managing and operating Prometheus clusters. It simplifies the deployment and management of Prometheus instances and related monitoring components.

7. **`pod/monitoring-kube-state-metrics-74f4d8858f-n5hw4:`**
   - **Role:** This pod hosts an instance of kube-state-metrics, which is responsible for collecting and exposing various metrics about the Kubernetes cluster's state.

8. **`pod/monitoring-prometheus-node-exporter-xxlt9:`**
   - **Role:** This pod runs Prometheus Node Exporter, which collects system-level metrics from the host machine where it is deployed. These metrics include CPU usage, memory usage, disk space, network statistics, etc.

9. **`pod/prometheus-monitoring-kube-prometheus-prometheus-0:`**
   - **Role:** This pod hosts an instance of Prometheus.

10. **`pod/vault-0:`**
    - **Role:** This pod is part of a HashiCorp Vault deployment and represents an instance of Vault, a tool used for managing secrets and protecting sensitive data. It provides a secure way to store and access credentials, API keys, and other confidential information.

11. **`pod/vault-agent-injector-5cd8b87c6c-fhxvs:`**
    - **Role:** This pod runs the Vault Agent Injector, a component used for automatically injecting Vault secrets into Kubernetes pods. It helps applications running in Kubernetes to securely access secrets stored in HashiCorp Vault.


Stateful sets:
1. **`statefulset.apps/alertmanager-monitoring-kube-prometheus-alertmanager:`**
   - **Description:** Manages the deployment of Alertmanager instances in a Kubernetes cluster.

2. **`statefulset.apps/app-go-chart:`**
   - **Description:** Go app StatefulSet.

3. **`statefulset.apps/app-python-chart:`**
   - **Description:** Python app StatefulSet.

4. **`statefulset.apps/prometheus-monitoring-kube-prometheus-prometheus:`**
   - **Description:** a StatefulSet that manages the deployment of Prometheus instances.

5. **`statefulset.apps/vault:`**
   - **Description:** a StatefulSet for managing the deployment of Vault instances in the Kubernetes cluster.

Services:
Correspond to each pod described above.

Persistent volumes:
Those we have added in previous labs.

Configmaps:
Contains configurations for the operation of kube-prometheus-stack.

## Utilize Grafana Dashboards:
Access Grafana using `minikube service monitoring-grafana` is not possible:
```
$ minikube service monitoring-grafana
|-----------|--------------------|-------------|--------------|
| NAMESPACE |        NAME        | TARGET PORT |     URL      |
|-----------|--------------------|-------------|--------------|
| default   | monitoring-grafana |             | No node port |
|-----------|--------------------|-------------|--------------|
😿  service default/monitoring-grafana has no node port
```
Since Grafana within kube-prometheus-stack package has ClusterIP type of service, it is only reachable within the cluster.

We can work around this using port-forward:
```sh
kubectl port-forward services/monitoring-grafana 30080:80
```

Since kube-prometheus-stack has some known problems with launching etcd, we are unable to get some metrics.
Below I show metrics which are working on minikube:

1. Check CPU and Memory consumption of your StatefulSet.

    ![cpu](https://i.imgur.com/yBkNT0G.png)
    ![mem](https://i.imgur.com/LUPNUwe.png)
    ![cpucluster](https://i.imgur.com/VAexT37.png)

2. Identify Pods with higher and lower CPU usage in the default namespace.
    ![cpu](https://i.imgur.com/yBkNT0G.png)

3. Monitor node memory usage in percentage and megabytes.
+ Per-node memore usage not available in minikube:
    ![nodemem](https://i.imgur.com/K99g7Ma.png)
+ Other memory metrics:
    ![metrmem](https://i.imgur.com/WT3Bsf6.png)

4. Count the number of pods and containers managed by the Kubelet service.
![number of pods and containers managed](https://i.imgur.com/6GjfN8O.png)

5. Evaluate network usage of Pods in the default namespace.

+ Network usage of pods dashboard is not working:
    ![podsnetworkingdash](https://i.imgur.com/JqmYoM2.png)
+ But we can get some other network metrics:
    ![network](https://i.imgur.com/0BSt4HM.png)

6. Determine the number of active alerts; also check the Web UI with `minikube service monitoring-kube-prometheus-alertmanager`.

    ![alerts](https://i.imgur.com/e1KFClk.png)
    ![alertsmgr](https://i.imgur.com/obRhrNm.png)


## Implement Init Container:
I do wget on example.com in my init container:
![init container](https://i.imgur.com/iK0kSFQ.png)

## Bonus

### App Metrics
I have added metrics scraping from apps.
App Go:
![gometrics](https://i.imgur.com/CmevG56.png)
App Python:
![pymetrics](https://i.imgur.com/udCk1bu.png)

### Init Container Queue
![initqueue](https://i.imgur.com/hZFo6pj.png)